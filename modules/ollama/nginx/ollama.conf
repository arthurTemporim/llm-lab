# nginx/ollama.conf
server {
  listen 11434;
  server_name _;

  # Origin do Obsidian (Electron): app://obsidian.md
  set $obsidian_origin "app://obsidian.md";

  # ========== Preflight (OPTIONS) ==========
  if ($request_method = OPTIONS) {
    add_header Access-Control-Allow-Origin $obsidian_origin always;
    add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Authorization, Content-Type, Accept, Accept-Language, Cache-Control" always;
    add_header Access-Control-Max-Age 86400 always;
    add_header Access-Control-Allow-Credentials "true" always;
    return 204;
  }

  # ========== Proxy para o Ollama ==========
  location / {
    # CORS em requisições "reais"
    add_header Access-Control-Allow-Origin $obsidian_origin always;
    add_header Access-Control-Allow-Credentials "true" always;

    # Upstream para o container 'ollama'
    proxy_pass http://ollama:11434;

    # SSE / streaming estável para /api/chat
    proxy_http_version 1.1;
    proxy_buffering off;
    proxy_request_buffering off;
    proxy_set_header Connection "";
    chunked_transfer_encoding off;

    # Evitar cache em stream
    add_header Cache-Control "no-cache";
  }
}
